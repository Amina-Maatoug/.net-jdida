@page "/ordonnances/create"
@page "/ordonnances/edit/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using pharmacieBlazor.Models
@using pharmacieBlazor.Services
@attribute [Authorize]
@inject OrdonnanceService OrdonnanceService
@inject PatientService PatientService
@inject MedicamentService MedicamentService
@inject AccountService AccountService
@inject NavigationManager Navigation

<h3>
    <i class="bi bi-file-earmark-medical"></i> @(Id == 0 ? "Créer" : "Modifier") une Ordonnance
</h3>

@if (isLoadingData)
{
    <div class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <p>Chargement des données...</p>
    </div>
}
else
{
    <EditForm Model="@ordonnance" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />
        <!-- Rest of form -->
    </EditForm>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private OrdonnanceDto ordonnance = new();
    private List<PatientDto> patients = new();
    private List<MedicamentDto> medicaments = new();
    private UserProfileDto? currentUser;

    private bool isSaving = false;
    private bool isLoadingData = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadReferenceData();

        if (Id != 0)
        {
            var existing = await OrdonnanceService.GetOrdonnanceByIdAsync(Id);
            if (existing != null)
                ordonnance = existing;
            else
                Navigation.NavigateTo("/ordonnances");
        }

        isLoadingData = false;
    }

    private async Task LoadReferenceData()
    {
        try
        {
            patients = await PatientService.GetAllPatientsAsync();
            medicaments = await MedicamentService.GetAllMedicamentsAsync();
            currentUser = await AccountService.GetMonProfilAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur chargement données : {ex.Message}");
        }
    }

    private void ToggleMedicament(int medicamentId, bool isChecked)
    {
        if (isChecked && !ordonnance.MedicamentIds.Contains(medicamentId))
            ordonnance.MedicamentIds.Add(medicamentId);
        else
            ordonnance.MedicamentIds.Remove(medicamentId);
    }

    private async Task HandleValidSubmit()
    {
        isSaving = true;
        try
        {
            if (currentUser != null)
                ordonnance.PharmacienId = currentUser.Id;

            bool success = Id == 0
                ? await OrdonnanceService.CreateOrdonnanceAsync(ordonnance)
                : await OrdonnanceService.UpdateOrdonnanceAsync(ordonnance);

            if (success)
                Navigation.NavigateTo("/ordonnances");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/ordonnances");
    }
}
